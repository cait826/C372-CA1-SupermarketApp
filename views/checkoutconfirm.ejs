<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Order Confirmation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body{background-color: #f8f9fa;} .product-img{width:72px;height:72px;object-fit:cover;border-radius:6px;} </style>
</head>
<body>
  <% if (!orderCompleted) { %>
    <div class="container py-5">
      <div class="alert alert-danger">Your order could not be processed.</div>
    </div>
  <% } else { %>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10">
        <div class="card">
          <div class="card-body">

            <h2 class="mb-3 text-success">Your Order Has Been Completed!</h2>

            <% 
              const ord = order || {};
              const orderId = ord.id || '';
              const orderDate = ord.order_date ? (new Date(ord.order_date)).toLocaleString() : '';
              const status = ord.status || '';
              const list = Array.isArray(items) ? items : [];
              const totalAmount = Number(total ?? ord.total_price ?? 0);
            %>

            <div class="mb-4">
              <div class="row">
                <div class="col-sm-6">
                  <p class="mb-1"><strong>Order ID:</strong> <%= orderId %></p>
                  <p class="mb-1"><strong>Order Date:</strong> <%= orderDate %></p>
                </div>
                <div class="col-sm-6 text-sm-end">
                  <p class="mb-1"><strong>Status:</strong> <%= status %></p>
                  <p class="mb-1"><strong>Total:</strong> $<%= totalAmount.toFixed(2) %></p>
                </div>
              </div>
            </div>

            <% if (list.length) { %>
              <div class="table-responsive mb-4">
                <table class="table align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Product</th>
                      <th>Image</th>
                      <th class="text-end">Price (each)</th>
                      <th class="text-end">Quantity</th>
                      <th class="text-end">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% list.forEach(function(it){ 
                         const name = it.productName || it.product_name || 'Product';
                         const img = it.image || '';
                         const price = Number(it.priceEach ?? it.price_each ?? it.price ?? 0);
                         const qty = Number(it.quantity ?? 0);
                         const subtotal = price * qty;
                    %>
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <% if (img) { %>
                              <img src="/images/<%= img %>" alt="<%= name %>" class="product-img me-3">
                            <% } %>
                            <div><%= name %></div>
                          </div>
                        </td>
                        <td>
                          <% if (!img) { %>
                            <span class="text-muted">No image</span>
                          <% } %>
                        </td>
                        <td class="text-end">$<%= price.toFixed(2) %></td>
                        <td class="text-end"><%= qty %></td>
                        <td class="text-end">$<%= subtotal.toFixed(2) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="alert alert-info">No items found for this order.</div>
            <% } %>

            <div class="d-flex gap-2">
              <% if (orderId) { %>
                <a href="/invoice/<%= orderId %>" class="btn btn-primary">View Invoice</a>
              <% } %>
              <a href="/shopping" class="btn btn-outline-secondary">Continue Shopping</a>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
