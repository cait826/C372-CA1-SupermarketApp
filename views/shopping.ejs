<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #e3f2fd; font-family: "Helvetica Neue", Arial, sans-serif; }
    .card { transition: transform 0.2s ease, box-shadow 0.2s ease; border-radius: 10px; }
    .card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .card-title a { text-decoration: none; color: #0d6efd; }
    .card-title a:hover { text-decoration: underline; }
    .product-img { height:180px; object-fit:cover; border-top-left-radius: 10px; border-top-right-radius: 10px; }
    .btn-sm { padding: .28rem .6rem; font-size: .82rem; }
    .meta-line { color:#495057; }
    .dark-mode { background-color: #121212 !important; color: white !important; }
    .dark-mode .card { background-color: #1e1e1e !important; border-color: #333 !important; color: #ddd !important; }
    .dark-mode .card-title a { color: #7fb1ff; }
    .dark-mode .navbar { background-color: #0b2540 !important; }
    .dark-toggle-btn { background: transparent; border: none; color: #fff; font-size: 1.0rem; }
    @media (max-width: 575.98px) {
      .product-img { height:140px; }
    }
  </style>
  <title>Supermarket App</title>
</head>
<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Supermarket App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/cart" style="color: #4a9eff;">View Cart</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/favorites" style="color: #4a9eff;">Your Favorites</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout" style="color: #4a9eff;">Logout</a>
            </li>
          </ul>

          <!-- Dark mode toggle button (client-side only) -->
          <div class="d-flex align-items-center">
            <button id="darkModeToggle" class="btn btn-outline-light btn-sm me-2" title="Toggle dark mode">üåô Dark Mode</button>
          </div>
        </div>
      </div>
    </nav>

  <div class="container py-4">
    <% if (user) { %>
      <h3 class="mt-1">Welcome, <%= user.username %>! (<%= user.role %>)</h3>
    <% } %>
    <br>
    <div class="text-center"><h2>Products from Supermarket</h2></div>
    <br>

    <!-- search function (unchanged) -->
     <form action="/products/search" method="GET" class="search-form mb-3 d-flex gap-2">
      <input 
          type="text" 
          name="q" 
          placeholder="Search products..." 
          value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
          class="form-control"
          required
      >
      <button type="submit" class="btn btn-primary">Search</button>
        <% if (typeof searchQuery !== 'undefined' && searchQuery) { %>
        <a href="<%= user.role === 'admin' ? '/inventory' : '/shopping' %>" class="btn btn-outline-secondary">Clear Search</a>
      <% } %>
      </form>

      <% if (typeof searchQuery !== 'undefined' && searchQuery) { %>
        <p class="search-results text-muted">
        Found <%= products.length %> result(s) for "<%= searchQuery %>"
        </p>
      <% } %>
      <% var selectedCategory = typeof selectedCategory !== 'undefined' ? selectedCategory : 'All'; %>

      <form action="/products" method="GET" class="filter-form mb-4">
        <select name="category" class="form-select w-auto" onchange="this.form.submit()">
        <option value="All" <%= selectedCategory === 'All' ? 'selected' : '' %>>All Categories</option>
        <option value="Produce" <%= selectedCategory === 'Produce' ? 'selected' : '' %>>Produce</option>
        <option value="Drinks" <%= selectedCategory === 'Drinks' ? 'selected' : '' %>>Drinks</option>
        <option value="Others" <%= selectedCategory === 'Others' ? 'selected' : '' %>>Others</option>
    </select>
  </form>

    <!-- Product grid (3 per row desktop, 2 tablet, 1 mobile) -->
    <div class="row">
      <% for(let i=0; i < products.length; i++) { 
           const prod = products[i];
      %>
        <div class="col-md-4 col-sm-6 mb-4">
          <div class="card shadow-sm h-100">
            <% if (prod.image) { %>
              <img src="/images/<%= prod.image %>" class="card-img-top product-img" alt="Product Image">
            <% } else { %>
              <div class="bg-secondary d-flex align-items-center justify-content-center product-img text-white">No image</div>
            <% } %>

            <div class="card-body text-center d-flex flex-column">
              <h5 class="card-title mb-2">
                <a href="/product/<%= prod.id %>"><%= prod.productName %></a>
              </h5>

              <p class="mb-1"><strong>Price:</strong> $<%= prod.price.toFixed(2) %></p>
              <p class="mb-1"><strong>In Stock:</strong> <%= prod.quantity %></p>

              <p class="mb-1 meta-line">‚≠ê <%= (prod.avgRating !== undefined && prod.avgRating !== null) ? prod.avgRating.toFixed(1) : "0.0" %> (<%= prod.reviewCount || 0 %> reviews)</p>
              <p class="mb-2 meta-line">‚ù§Ô∏è <%= prod.favoriteCount || 0 %> favorites</p>

              <div class="mt-auto">
                <form method="POST" action="/favorite/<%= prod.id %>" class="d-inline">
                  <button class="btn btn-outline-danger btn-sm">‚ù§Ô∏è Favorite</button>
                </form>

                <form action="/add-to-cart/<%= prod.id %>" method="POST" class="d-inline ms-2">
                  <input type="hidden" name="quantity" value="1">
                  <button type="submit" class="btn btn-primary btn-sm">Add to Cart</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    // Dark mode toggle with localStorage
    (function(){
      const body = document.body;
      const btn = document.getElementById('darkModeToggle');

      function applyTheme(isDark) {
        if (isDark) {
          body.classList.add('dark-mode');
          btn.textContent = '‚òÄÔ∏è Light Mode';
          btn.classList.remove('btn-outline-light');
          btn.classList.add('btn-light', 'text-dark');
        } else {
          body.classList.remove('dark-mode');
          btn.textContent = 'üåô Dark Mode';
          btn.classList.remove('btn-light', 'text-dark');
          btn.classList.add('btn-outline-light');
        }
      }

      const stored = localStorage.getItem('supermarket_dark_mode');
      const prefersDark = stored === '1' || (stored === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      applyTheme(Boolean(prefersDark));

      btn.addEventListener('click', function(e){
        e.preventDefault();
        const isDark = body.classList.toggle('dark-mode');
        localStorage.setItem('supermarket_dark_mode', isDark ? '1' : '0');
        applyTheme(isDark);
      });
    })();
  </script>
  <%- include("./partials/footer") %>
</body>

</html>
